---
title: "Lab 2"
author: "Jonathan Whiteley, Max Hoff, Connor McCormick"
subtitle: 'w203: Statistics for Data Science'

output:
  pdf_document: default
---

```{r setup, include=FALSE, warning=FALSE, message=FALSE}
install.packages('corrplot')

library(corrplot)
library(ggplot2)
library(tidyverse)
library(car)
library(lmtest)
library(sandwich)
library(stargazer)
library(patchwork)
```

```{r setup chunks, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r source functions from project, echo = FALSE}
source('../src/data/clean_and_join.R')
```


# Introduction

The Covid-19 pandemic has upended lifestyles to a degree that most people couldnâ€™t have imagined a couple years ago. One of the more interesting changes to lifestyles has been a significant increase in visits to parks, as people have been restricted to local travel. As developed world vaccinations increase, this raises an interesting question about the future of parks. Will some of the lifestyle changes from the pandemic stick around? Which ones? Are visits to parks going to be a permanent fixture of American life? This brings us to our proposed research question:

*Research question:* How do Covid-19 vaccination rates within a county impact visits to parks within that county?  

Finding the answer to this question will bring important insight into how the Department of Tourism should allocate resources towards parks. 

# Model Building Process

## Variables
We will begin 

To begin our modeling process, we needed to define the exact variable that we wanted to measure. Since we are researching how the rates of vaccinations effect park visits within a county, it made sense that our outcome variable would 

We used the following variables in our analysis: (FILL IN, add data dictionaries/links to references folder if needed)

- `parks_chg` : Google Maps COVID-19 Community Mobility Report
- `full_vax_count` : CDC
- `full_vax_pct ` : CDC
- `cases` : The New York Times
- `deaths` : The New York Times
- `mask_percent` : Percent of respondents in each county who indicated "ALWAYS" on a five point Likert scale from NEVER to ALWAYS. Each participant was asked: "How often do you wear a mask in public when you expect to be within six feet of another person?". This survey was conducted a single time in July 2020 by survey firm Dynata at the request of The New York Times.
- `median_age_years` : Median age by county, 2019-2020 collected by the Census Bureau. 


```{r Data Wrangling, include=FALSE}
parks <- read_csv('~/lab_2_Whiteley_Hoff_McCormick/data/external/Google_Mobility_Report_out.csv')
vax <- read_csv('~/lab_2_Whiteley_Hoff_McCormick/data/external/CDC_Vaccinations_out.csv')
covid <- read_csv('~/lab_2_Whiteley_Hoff_McCormick/data/external/covid_cases_data.csv')
mask_use <- read_csv('~/lab_2_Whiteley_Hoff_McCormick/data/external/mask-use-by-county.csv')
age <- read_csv('~/lab_2_Whiteley_Hoff_McCormick/data/external/census_demographics.csv')
```

```{r clean_and_join data from source function}
data <- clean_and_join()
head(data)
```

## EDA

```{r histograms, include=FALSE, message=FALSE, fig.width=15, fig.height=6}
park_traffic_histogram <- data %>% 
    ggplot() + 
    aes(x=parks_chg) + 
    geom_histogram(color='firebrick4', fill="firebrick1") +
    labs(x='Percent Change', y='Bin Count', 
         title='Distribution of Change Percentages for Park Traffic')

vax_rate_histogram <- data %>% 
    ggplot() + 
    aes(x=full_vax_pct) + 
    geom_histogram(color='darkblue', fill="lightblue") +
    labs(x='Percent Fully Vaccinated', y='Bin Count', 
         title='Distribution of Population Percentages of Fully Vaccinated Individuals by County')

covid_case_histogram <- data %>% 
    ggplot() + 
    aes(x=cases) + 
    geom_histogram(color='darkgreen', fill="lightgreen") +
    scale_x_log10() + 
    labs(x='Numer of Cases in County', y='Bin Count', 
         title='Distribution of Case Counts per County')

covid_death_histogram <- data %>% 
    ggplot() + 
    aes(x=deaths) + 
    geom_histogram(color='purple', fill="violet") +
    scale_x_log10() + 
    labs(x='Numer of Deaths in County', y='Bin Count', 
         title='Distribution of Death Counts per County')

mask_use_histogram <- data %>% 
    ggplot() + 
    aes(x=mask_percent) + 
    geom_histogram(color='orange', fill="darkorange") + 
    labs(x='Percent of Residents Who Always Wear Masks in Public', y='Bin Count', 
         title='Distribution of Percentage Mask Use by County')

age_histogram <- data %>% 
    ggplot() + 
    aes(x=median_age_years) + 
    geom_histogram(color='blue', fill="darkblue") +
    scale_x_log10() + 
    labs(x='Median Age', y='Bin Count', 
         title='Distribution of Median Age by County')

park_traffic_histogram/vax_rate_histogram/age_histogram|covid_case_histogram/covid_death_histogram/mask_use_histogram
```

```{r, include=FALSE, message=FALSE, warning=FALSE}
park_vs_vax_scatter <- 
  data %>% 
    ggplot() + 
    aes(x=full_vax_count, y=parks_chg) + 
    scale_x_log10() + 
    geom_point() +
    geom_smooth() +
    labs(x='Number of Vaccinations', y='Percent Change in Traffic at Parks', 
         title='Vaccination Count VS Change in Park Traffic by County')
park_vs_vax_scatter
```

```{r correlation, include=FALSE}

corrplot::corrplot(cor(data[c("parks_chg", "full_vax_pct", "full_vax_count" , 
                              "cases", "deaths", "mask_percent", 
                              "median_age_years")], use = "complete.obs"
                       ), 
                   method = "color", order="AOE", 
                   diag=FALSE, addCoef.col = "white")
```

## Modeling

```{r, include=FALSE}
model_1 <- lm(parks_chg ~ full_vax_count, data=data)
model_2 <- lm(parks_chg ~ full_vax_count + log10(cases), data=data)
model_3 <- lm(parks_chg ~ full_vax_count + full_vax_pct + log10(cases) + 
                log10(deaths) + mask_percent + median_age_years, data=data)

```

# Model Building Process

## Data
We begin by discussing the data we will use for modeling the hypothesized effect. We have enlisted the use of five different data sets to help us in our : 

- __COVID-19 Community Mobility Report__: This data that was collected by Google, describes the percent increase/decrease of visits to specific categories of locations such as retail centers, transit stations, grocery store, etc. In our case, we will be looking at the percent trends over time of visits to parks. The data coverage begins from a baseline measurement taken on January 1st, 2021 and is updated routinely. Since we will not be performing a time-series analysis, we decided to select a slice of the data from June 30th, 2021. The variables that we are concerned with in this data set are the FIPS code (used for merging data by county) and the park visits change from baseline.

- __CDC Data on Vaccinations__: This data set was provided by the CDC and contained a lot of information on vaccination rates at a county level. It contains both hard vaccination rates and percentages. Additionally, it provides these vaccination numbers drilled down to age subsets as well as at a cumulative level. Lastly, this data contains a FIPS code for data merging. The variables of concern for this data set are the FIPS code, the hard cumulative vaccination rate, and the percentage vaccination rate. We decided not to use any of the age subset rates since we hypothesize that all age demographics are reasonably likely to visit a park. 

- __New York Times Covid-19 Data__: This data set is similar to the vaccination data provided by the CDC but instead reports on actual Covid-19 cases at a county level. In addition to case data, this data set also contains reports on deaths from Covid-19 as well. This data set is structured in a time series format, similar to the Covid-19 Community Mobility Report. So in order to choose a proper cross-section for analysis, we selected cases from 2-weeks before our selected date for the park visits percent change (June 30th, 2021) up until 2-weeks after, based on the CDC's recommendation of a two week life-cycle for virus contraction to full recovery. The variables that we are concerned with in this data set are the FIPS code, date (for cross-section selection), county, case counts, and death counts.

- __Mask-Wearing Survey Data__: In the same repository as the NYT Covid-19 data set, we found another data set that came from a large number of interviews conducted online by a survey firm named Dynata at the request of The New York Times. They surveyed people at a county level about their mask use between July 2nd and July 14th. Since this survey collection period is so close to the covid case date cross section we selected and the date selected for park visit percent change, we're assuming that the respondent's mask wearing habits are not going to change that much so we can use this as one of our explanatory variables. The variables of concern for this data set are FIPS code and mask use.

- __Census Demographic Data__: Lastly, we utilized the United States Census Bureau's Population Estimates Program data releases to retrieve a data set that describes the population size and median age of an area at the county level. The variables of concern in this data set are the FIPS code, the population size, and the median age.

## Models
To begin our modeling process, we needed to define the exact variable that we wanted to measure. Since we are researching how the rates of vaccinations effect park visits within a county, it made sense that our outcome variable would be the percent change in park visits from the Covid-19 Community Mobility Report data set from Google. Note that the category parks includes regions such as national parks, public beaches, marinas, dog parks, plazas, and public gardens. Given the flexibility in the definition of a park for this analysis, we want to make clear the range of the outcome variable that we are analyzing.

To measure the percent change in park visits, we hypothesized that the main explanatory variable would be the rate of vaccinations within a county. In a way, the vaccination rate of a particular region somewhat symbolizes a transition state from pandemic operations for that region. We are unsure how this will affect the number of visitations of a particular park or set of parks however. On the one hand we have parks becoming a replacement for other locations that were closed during the pandemic, so this may indicate that park traffic will decrease as vaccination rates increase and people become more comfortable being in close quarters again. On the other hand, we have the possibility that people were nervous about going to parks during the pandemic, so in this case, we may expect to see an increase in park traffic as regions transition out of pandemic tendencies. In addition to the vaccination rate of a region, we also have identified the number of cases in a region as an explanatory variable. One thing we've noted for this additional expalanatory variable, however, is that there is likely a strong level of collinearity between case rate and vaccination rate. We will discuss this further in the model limitations section. In addition to these two main explanatory variables, we have identified a few other covariates we plan on including in the larger versions of the model; we will dicuss these further below. The final conclusion we plan on reaching is one that explains the causal nature of vaccination rates, and case rates for that matter, on the percent change in visits to parks in an area. 

Because of the nature of our variables and the causal effect that we are searching for, we have determined our model to be an expanatory model. We decided to start off with a base model or *limited model* that just regresses change in park traffic on vaccination rate. Since this is the key variable which we are trying to determine a causal relationship between, we decided it best to use this as the only explanatory variable in our first model. 

In our second model however, we decided to include the case count variable as a covariate. As mentioned before, we identified some collinearity between cases and vaccination rates in our EDA which may prove a little problematic. That being said, we feel that including this covariate will still influence the outcome variable so it is important to include, as long as we are aware of the potential collinearity effects. Another alteration we made to the second model was adding a log transformation to the cases covariate. While performing the EDA, we noticed that the distribution of the cases variable had a pretty strong right skew, so we added a log transformation the bring the variable closer to a normal distribution.

Finally, for our third model, we included all relevant covariates that were available and we believed would have an influence on the change in park visits from baseline. So in addition to vaccination count and case count variables, we also included death counts, mask-wearing percentages, and the median age in years per county. Furthermore, we also decided to include vaccination percentage in addition to vaccination count since we figured that vaccination percentage would carry some additional information due to the fact that a percentage scales better with varying county population sizes. Again, we needed to perform a log transformation on the covid cases variable in order to acheive data linearity, and for the same reason, we performed a log transformation on the death count variable as well. It is important to point out that more so than model two, there will be some collinearity between some of the explanatory variables in this model iteration. For starters, we still have the collinearity between vaccination counts and case counts, but now we also have collinearity between vaccination percentage and these two variables. Moreover, there is most likely collinearity between these three variables and death counts and mask-wearing percentage as well. Addressing the final variable of median age, it is possibile that there is some collinearity between this variable and the other explanatory variables, however according to our correlation plot in the EDA section, it seems like there is only a small correlation between median age and vaccine count. At a high level, the variables we've included in the third model combine to more or less explain the severity of the pandemic in a particular region in addition to the response. And to wrap it all up, this explanation is the key that we are using to measure our outcome variable of change from baseline in visits to parks.

```{r Covariate and Variable Name Table, warning=FALSE, message=FALSE, include=TRUE}
variable_names <- c("full_vax_count", "full_vax_pct", "log_10_cases", 
                    "log_10_deaths", "mask_percent", "median_age_years")

covariates <- c("Number of citizens vaccinated in a particular county", 
               "Percent of citizens vaccinated in a particular county", 
               "Log transformed count of cases in a particular county", 
               "Log transformed count of deaths in a particular county", 
               "Percentage of the population that reported wearing masks frequently", 
               "Median age of the population of a particular county")

cov_var_names <- data.frame("Covariate" = covariates, "Variable Name" = variable_names)

col_names <- c("Covariate", "Variable Name")
knitr::kable(cov_var_names, col.names = col_names)
```

## F-Test

We run an F-test to get an indication if our additional features are improving performance of the model. The null hypothesis is that the short model is as good at explaining the variance in `parks_chg` as the two long models.The rejection criteria used is p-value < 0.05 for the F-Test.
We conclude that we are able to reject the null hypothesis for Model 3 but not Model 2, as our test returned a p-value much lower than 0.05 for Model 3. As a result, we can conclude that the additional features in Model 3 are improving the performance of our model and that our model improved more than if all those indicators had been set to zero.

```{r}
anova(model_1, model_2, model_3, test = "F")
```


# Regression Table
```{r latex output, warning=FALSE}

se.model_1 = coeftest(model_1, vcov = vcovHC)[ , "Std. Error"]
se.model_2 = coeftest(model_2, vcov = vcovHC)[ , "Std. Error"]
se.model_3 = coeftest(model_2, vcov = vcovHC)[ , "Std. Error"]

stargazer(model_1, model_2, model_3, type = "text",
          se = list(se.model_1, se.model_2, se.model_3),
          star.cutoffs = c(0.05, 0.01, 0.001), title = "Table 1: The relationship between vaccination rates and park traffic")

```

# Model Limitations

Upon Assessing all five assumptions of the CLM, we found evidence that our model does not fit all the necessary assumptions for the CLM framework - specifically the assumptions for IID sampling, linear conditional expectation, and homoskedastic errors.

> 1. **IID Sampling:** To assess IID data, we need to know about the sampling process for each set of variables. The county level data we analyzed was gathered from several different primary sources. We have reason to believe that clustering of similar values for variables X, Y , Z (FILL IN HERE) by region may violate independence within the sampling process.

@Max feel free to fill in variables of concern here and add additional color. Given what Sush said i think we should include this blurb in the final report re concerns on IID but proceeded.

> 2. **No Perfect Colinearity:** To test this assumption, we can look at our coefficients, and notice that R has not dropped any variables. This tells us that there is no perfect collinearity.  This assumption also includes the requirement that a BLP exists, which may not happen if there are heavy tails.  In this case, we don't see any distributions that look like they have unusually low or high values.

```{r test no perfect colinearity, include=FALSE}
model_1$coefficients
model_2$coefficients
model_3$coefficients
```


> 3. **Linear Conditional Expectation:**  To assess whether there is a linear conditional expectation, we've looked at the predicted vs. residuals of the model. The plot of both below indicates a pretty clear non-linear relationship. This is concerning and does not give us confidence that there is a linear conditional expectation here.

```{r code and plots assessing linear conditional expectation}

data %>% 
  mutate(
    model_preds = predict(model_1), 
    model_resids = resid(model_1)
  ) %>% 
  ggplot(aes(model_preds, model_resids)) + 
  geom_point() + 
  stat_smooth()

data %>% 
  mutate(
    model_preds = predict(model_3), 
    model_resids = resid(model_3)
  ) %>% 
  ggplot(aes(model_preds, model_resids)) + 
  geom_point() + 
  stat_smooth()
```

```{r plot variables fitted, include=FALSE}
#include=FALSE

d <- data %>% 
  mutate(
    model_preds = predict(model_3), 
    model_resids = resid(model_3)
  )
full_vax_count_resids <- d %>%
  ggplot(aes(full_vax_count, model_resids)) +
  geom_point() +
  stat_smooth()

cases_resids <- d %>%
  ggplot(aes(log10(cases), model_resids)) +
  geom_point() +
  stat_smooth()

full_vax_count_resids / cases_resids

```

> 4. **Homoskedastic Errors:** To assess whether the distribution of the errors is homoskedastic or heteroskedastic, we can look at the residuals versus fitted plot again.  We see that the band increases in thickness as it goes from left to right for `full_vax_count`, getting quite wide on the upper side of the predicted values, which is slightly concerning. For `cases` we see a wide band on the left that tapers off and gets wide out to the right. 
We can also leverage a scale-location plot where we would see homoskedasticity would show up on this plot as a flat smoothing curve, which does not quite look like it is the case here, perhaps suggesting problems with homoskedasticity.

```{r code and plots assessing error variance}
plot(model_3, which=3)
```

> 5. **Normally Distributed Errors:** We are looking for evidence of normally distributed errors by examing the histogram of residuals and a qqplot. The normal shape of the histogram, yet flightly skewed right and the qqplot distribution shows the points from the quantiles forming a line that is roughly straight except off to the right side. This give us some confidence in stating that the errors are close to normally distributed. 

```{r code and plots assessing normally distributed errors}
# include=FALSE
plot_one <- d %>% 
  ggplot(aes(x = model_resids)) + 
  geom_histogram()
  
plot_two <- d %>% 
  ggplot(aes(sample = model_resids)) + 
  stat_qq() + stat_qq_line()

plot_one / plot_two 
```



# Omitted Variables


# Conclusion


## Model Comparison

## IID
> Clustering concerns
> Add in Age? MEDIAN_AGE_TOT from Census

---
title: "Lab 2"
author: "Jonathan Whiteley, Max Hoff, Connor McCormick"
subtitle: 'w203: Statistics for Data Science'

output:
  pdf_document: default
---

```{r setup, include=FALSE, warning=FALSE, message=FALSE}
install.packages('corrplot')

library(corrplot)
library(ggplot2)
library(tidyverse)
library(car)
library(lmtest)
library(sandwich)
library(stargazer)
library(patchwork)
```

```{r setup chunks, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

*Research question:* How do Covid-19 vaccination rates within a county impact visits to parks within that county?  

The Covid-19 pandemic has upended lifestyles to a degree that most people couldnâ€™t have imagined a couple years ago. One of the more interesting changes to lifestyles has been a significant increase in visits to parks, as people have been restricted to local travel. As developed world vaccinations increase, this raises an interesting question about the future of parks. Will some of the lifestyle changes from the pandemic stick around? Which ones? Are visits to parks going to be a permanent fixture of American life?

Finding the answer to this question will bring important insight into how the Department of Tourism should allocate resources towards parks. 



```{r}
parks <- read_csv('~/lab_2_Whiteley_Hoff_McCormick/data/external/Google_Mobility_Report_out.csv')
vax <- read_csv('~/lab_2_Whiteley_Hoff_McCormick/data/external/CDC_Vaccinations_out.csv')
covid <- read_csv('~/lab_2_Whiteley_Hoff_McCormick/data/external/covid_cases_data.csv')
mask_use <- read_csv('~/lab_2_Whiteley_Hoff_McCormick/data/external/mask-use-by-county.csv')
age <- read_csv('~/lab_2_Whiteley_Hoff_McCormick/data/external/census_demographics.csv')

covid <-
  covid %>%
    subset(
      date > as.Date("2021-06-16")
    ) %>%
    subset(
      date < as.Date("2021-07-14")
      )

### Subsetting the file and over-writing old file to save space on memory for us folks on datahub.
# write.csv(covid,"~/lab_2_Whiteley_Hoff_McCormick/data/external/covid_cases_data.csv", row.names = TRUE)

head(parks)
head(vax)
head(covid)
head(mask_use)
head(age)
```

```{r slim parks}
parks <- parks %>% 
  select(census_fips_code, 
         parks_percent_change_from_baseline) %>%
  rename(fips_code = census_fips_code,
         parks_chg = parks_percent_change_from_baseline) %>% 
  mutate(fips_code = as.character(fips_code))

vax <- vax %>% 
  select(FIPS, Recip_County, Recip_State, Series_Complete_Pop_Pct, 
         Series_Complete_Yes, SVI_CTGY) %>% 
  rename(fips_code = FIPS, 
         county = Recip_County, 
         state = Recip_State, 
         full_vax_pct = Series_Complete_Pop_Pct, 
         full_vax_count = Series_Complete_Yes, 
         social_vulnerability_index = SVI_CTGY)

covid <- covid %>% 
  select(date, county, fips, cases, deaths) %>% 
  rename(fips_code = fips) %>% 
  group_by(fips_code) %>% 
  summarise_at(vars(cases, deaths), sum)

mask_use <- mask_use %>% 
  select(COUNTYFP, ALWAYS) %>% 
  rename(fips_code = COUNTYFP, 
         mask_percent = ALWAYS) %>% 
  mutate(mask_percent = mask_percent*100)

age <- age %>% 
  select(fips_code, median_age_years)

head(parks)
head(vax)
head(covid)
head(mask_use)
head(age)

```

```{r join results and campaigns}
data <- parks %>%
  dplyr::inner_join(vax, by = c("fips_code")) %>% 
  dplyr::inner_join(covid, by = c("fips_code")) %>% 
  dplyr::inner_join(mask_use, by = c("fips_code")) %>% 
  dplyr::inner_join(age, by = c("fips_code"))

head(data)
```

```{r, message=FALSE, fig.width=15, fig.height=6}
park_traffic_histogram <- data %>% 
    ggplot() + 
    aes(x=parks_chg) + 
    geom_histogram(color='firebrick4', fill="firebrick1") +
    labs(x='Percent Change', y='Bin Count', title='Distribution of Change Percentages for Park Traffic')

vax_rate_histogram <- data %>% 
    ggplot() + 
    aes(x=full_vax_pct) + 
    geom_histogram(color='darkblue', fill="lightblue") +
    labs(x='Percent Fully Vaccinated', y='Bin Count', title='Distribution of Population Percentages of Fully Vaccinated Individuals by County')

covid_case_histogram <- data %>% 
    ggplot() + 
    aes(x=cases) + 
    geom_histogram(color='darkgreen', fill="lightgreen") +
    scale_x_log10() + 
    labs(x='Numer of Cases in County', y='Bin Count', title='Distribution of Case Counts per County')

covid_death_histogram <- data %>% 
    ggplot() + 
    aes(x=deaths) + 
    geom_histogram(color='purple', fill="violet") +
    scale_x_log10() + 
    labs(x='Numer of Deaths in County', y='Bin Count', title='Distribution of Death Counts per County')

mask_use_histogram <- data %>% 
    ggplot() + 
    aes(x=mask_percent) + 
    geom_histogram(color='orange', fill="darkorange") + 
    labs(x='Percent of Residents Who Always Wear Masks in Public', y='Bin Count', title='Distribution of Percentage Mask Use by County')

age_histogram <- data %>% 
    ggplot() + 
    aes(x=median_age_years) + 
    geom_histogram(color='blue', fill="darkblue") +
    scale_x_log10() + 
    labs(x='Median Age', y='Bin Count', title='Distribution of Median Age by County')

park_traffic_histogram/vax_rate_histogram/age_histogram|covid_case_histogram/covid_death_histogram/mask_use_histogram
```

```{r, message=FALSE, warning=FALSE}
park_vs_vax_scatter <- 
  data %>% 
    ggplot() + 
    aes(x=full_vax_count, y=parks_chg) + 
    scale_x_log10() + 
    geom_point() +
    geom_smooth() +
    labs(x='Number of Vaccinations', y='Percent Change in Traffic at Parks', title='Vaccination Count VS Change in Park Traffic by County')
park_vs_vax_scatter
```

```{r correlation}

corrplot::corrplot(cor(data[c("parks_chg", "full_vax_pct", "full_vax_count" , "cases", "deaths", "mask_percent", "median_age_years")], use = "complete.obs"), 
                   method = "color", order="AOE", 
                   diag=FALSE, addCoef.col = "white")
```


```{r}
model_1 <- lm(parks_chg ~ full_vax_count, data=data)
model_2 <- lm(parks_chg ~ full_vax_count + log10(cases), data=data)
model_3 <- lm(parks_chg ~ full_vax_count + full_vax_pct + log10(cases) + log10(deaths) + mask_percent + median_age_years, data=data)

```


```{r latex output, warning=FALSE}

se.model_1 = coeftest(model_1, vcov = vcovHC)[ , "Std. Error"]
se.model_2 = coeftest(model_2, vcov = vcovHC)[ , "Std. Error"]
se.model_3 = coeftest(model_2, vcov = vcovHC)[ , "Std. Error"]

stargazer(model_1, model_2, model_3, type = "text",
          se = list(se.model_1, se.model_2, se.model_3),
          star.cutoffs = c(0.05, 0.01, 0.001), title = "Table 1: The relationship between vaccination rates and park traffic")

```


## Model Comparison

## IID
> Clustering concerns
> Add in Age? MEDIAN_AGE_TOT from Census
